---
title: "CUNY MSDA 607 Week 3 Assignment"
author: "James Topor"
date: "February 6, 2016"
output: html_document
---

This script creates an R dataframe that shows rates of tuberculosis infection by country using data retrieved from both an SQL database and a .csv file. Data from these two sources will be refined to allow us to calculate the ratio __(# of tuberculosis cases / population)__ for each year within each listed country.

```{r, warning=FALSE, echo=FALSE, include=FALSE}
# load RODBC package
require(RODBC)
require(plyr)
require(dplyr)
```
# ---------------------------------------------------------------------------------------
### Data Sets

__Population Data__  
Annual population counts for each country are read from a .csv file given at:

https://raw.githubusercontent.com/jtopor/CUNY-MSDA-607/master/population.csv

This .csv file provides three columns:

1) Country name  
2) Year  
3) Population  

The records within the file are pre-sorted by year and then alphabetically by country name. 


__Tuberculosis Data__  
Tuberculosis data is assumed to reside within an SQL database. The R code given below makes use of R's __RODBC__ package to provide access to connect to an SQL server and subsequently access a database on that server named __tb__. 

# ---------------------------------------------------------------------------------------
*__IMPORTANT: This R code assumes that the user has the required 'tb' database installed on their own local SQL server. If the user does not have the 'tb' database installed, please download the 'tbdbcreate.sql' and 'tb.csv' files accessible via the following github links and install the database, bearing in mind that you may need to alter the 'LOAD DATA INFILE' command given on Line 27 of that file so that it comports with your specific computing environment. The 'tb.csv' file contains the data that will populate the 'tb' database. The data are automatically loaded into the database via the SQL sript's 'LOAD DATA INFILE' command mentioned above.__*

Path to 'tbdbcreate.sql' SQL script file:  
https://raw.githubusercontent.com/jtopor/CUNY-MSDA-607/master/tbdbcreate.sql  

Path to 'tb.csv' data file:  
https://raw.githubusercontent.com/jtopor/CUNY-MSDA-607/master/tb.csv

# ---------------------------------------------------------------------------------------


We'll connect to the local SQL server and the __tb__ database now so that we can make use of it during this discussion of the tuberculosis data:

```{r, warning=FALSE}
# establish connection to local SQL server
# NOTE: Be sure to set the server reference appropriately to comport with your own local 
# computing environment. 
con <- odbcConnect("local_server")

# select a database to use - in this case, the 'tb' database
sqlQuery(con, "use tb")
```


The __tb__ database contains a single table, also named 'tb', comprised of six columns and defined within the SQL database as follows:

1) country  varchar(100) NOT NULL 
2) year int NOT NULL,
3) sex varchar(6) NOT NULL,
4) child int NULL,
5) adult int NULL,
6) elderly int NULL

Each record within the __tb__ database tells us how many individuals of a given age category ('child', 'adult', or 'elderly') of a given gender were diagnosed with tuberculosis within a given country for a given year. For example, if we examine the counts for Angola for the year 2009, we are presented with the following for the six columns explained above:

```{r}
sqlQuery(con, "SELECT * FROM tb WHERE country = 'Angola' AND year = 2009")
```

As we can see, there are two separate records: one for females and one for males. Therefore, to find the total number of cases for a country for any given year we'll need to add up the various age category ('child', 'adult', or 'elderly') counts for both genders. For example, to find the total number of cases for Angola for the year 2009 we can make use of SQL's __SUM__ function if we provide the proper search constraints:

```{r}
sqlQuery(con, "SELECT SUM(child + adult + elderly) FROM tb WHERE country = 'Angola' AND year = 2009")
```

We'll make use of this approach as we work to combine data from the population.csv file with the data from the SQL database to find the $cases/population$ ratios we're looking for.

# ---------------------------------------------------------------------------------------
### Loading and Sorting the Population Data  

We start by reading the population.csv file from a Github web page and then sorting the data we've read so that it is ordered by country and then by year:

```{r, warning=FALSE}
# load the population.csv file from Github into a dataframe
# NOTE: The data has a 1 line header
popcsv <- read.csv("https://raw.githubusercontent.com/jtopor/CUNY-MSDA-607/master/population.csv", header = TRUE, stringsAsFactors = FALSE)

str(popcsv)
head(popcsv)

# sort the data frame by country & year using the 'arrange' function from 'plyr'
popcsv <- arrange(popcsv, country, year)
head(popcsv)
```

The resulting sorted list gives us the records sorted alphabetically by country name, and for each country name the years are ordered chronologically.

# ---------------------------------------------------------------------------------------
### Retrieving and Sorting the Tuberculosis Data

Let's start our work with the tuberculosis data by taking a peek at 50 sample records:
```{r}
sqlQuery(con, "SELECT * FROM tb ORDER BY country, year LIMIT 50")
```

Exploring this subset of the tuberculosis data we can see there are numerous records that lack values for one or more age groups. *__As such, for purposes of our ratio calculations herein, we will omit any country/year pairs that lack values for any of the age group/gender pairs.__* Any ratios we derive from partial data won't be valid metrics when compared to the records for which we have complete data.

The tuberculosis data can be sorted and loaded into an R dataframe with the following SQL query:
```{r}
tb_df <- sqlQuery(con, "SELECT country, year, SUM(child + adult + elderly) FROM tb
						GROUP BY country, year ORDER BY country, year", stringsAsFactors=F)

# rename third column to meaningful name
colnames(tb_df)[3] <- "cases"
head(tb_df)
```

With this one query we've retrieved, sorted, and summed the various valid *'age/gender'* category counts. Since we've sorted the data alphabetically by country name and ordered the records for any given country in chronological order by year, the structure of our tuberculosis dataframe conforms quite nicely with that of the population data we loaded earlier:

```{r}
str(popcsv)
str(tb_df)
```

# ---------------------------------------------------------------------------------------
### Ensuring Country Names Match Across Data Sets

Before proceeding any further we need to ensure that the country names within the two dataframes match each other. We can check this via the application of __dplyr__'s 'anti_join' function. That function will return a list of all elements of the first dataframe listed in the function's argument list that do not match the elements of the dataframe provided as the second argument. As such, if we find any non-matches we'll need to run the function a second time with the function arguments reversed so that we can identify the non-matching items of the second dataframe as well and then work toward resolving the inconsistencies.

```{r, warning=FALSE}
# get distinct country names from population data into char format for comparison
pop_country <- data.frame(unique(popcsv$country))
names(pop_country) <- 'country'

# get distinct country names from tb data
tb_country <- sqlQuery(con, "SELECT DISTINCT country FROM tb", stringsAsFactors=F)
names(tb_country) <- 'country'

# -----------------------------------------
# Now anti-join to check for mismatches
pop_nonmatch <- anti_join(pop_country, tb_country)
pop_nonmatch <- as.character(pop_nonmatch$country)
pop_nonmatch

tb_nonmatch <- anti_join(tb_country, pop_country)
tb_nonmatch <- as.character(tb_nonmatch$country)
tb_nonmatch
```

As we can see, our country names do not match up one-for-one across our two dataframes. It appears that the name utilized for the country of Ivory Coast differs between the two data sets. Therefore, we'll have to change the country name within one of our data frames to match that of the other. It doesn't really matter which one we choose to change, so we'll change the population data to match the name used for Ivory Coast in the tb data:

```{r, warning=FALSE}
# change Ivory Coast country name in popcsv to match that of tb data
popcsv$country[popcsv$country == pop_nonmatch] <- tb_nonmatch

# test to ensure there are now no mismatches between the two data sets
pop_country <- data.frame(unique(popcsv$country))
names(pop_country) <- 'country'
anti_join(pop_country, tb_country)

# re-sort popcsv to match tb data order
popcsv <- arrange(popcsv, country, year)
```

After changing the country name for Ivory Coast within the population data and re-checking to ensure the country names now match across the data sets, we've re-sorted the population data to align it with the tuberculosis data set.  

# ---------------------------------------------------------------------------------------
### Creating the Required 'Country-Year-Rate' Dataframe  

We can now compute the *'cases / population'* ratios we are looking for quite easily. Please note that any *'country/year'* pairs having missing values for the *'age/gender'* groupings will be indicated by '__NA__'. We create a new dataframe containing only the country name, year, and rate of tuberculosis for that year within that country:

```{r}
tb_rates <- data.frame(popcsv$country, popcsv$year, 
                       round((tb_df$cases / popcsv$population), 5))

# rename columns to meaningful names
names(tb_rates) <- c("Country", "Year", "Rate")

head(tb_rates)
```

This completes our required task: we now have a single data frame containing the rate of tuberculosis infection within a given country for a given year. However, we could, if we chose, consider other types of downstream data analysis and reporting that can be facilitated by our new dataframe. Some of these are discussed below

# ---------------------------------------------------------------------------------------
### How Might We Use the Infection Rate Data?  

The 'Country-Year-Rate' data we've compiled could be used in a variety of ways to help public health authorities and researchers identify countries or regions that are experiencing relatively high rates of tuberculosis infections. For example, a quick sort on the 'Rate' column can show us the countries and years with the highest infection rates:

```{r}
# Sort the rates in descending order
highrates <- arrange(tb_rates, desc(Rate), Country, Year)
head(highrates, n = 20)
```

A quick glance through this data shows that countries in Africa appear to have had the highest rates of infection during the years for which data are available. 

Other types of analysis could include identifying trends in infection rates. For example, are certain countries or regions experiencing either an increase or decrease in their infection rates? If certain countries are experiencing an uptick in cases, health authorities might want to step up their tuberculosis prevention and containment efforts within those countries as well as neighboring countries. 

Similarly, if certain countries are seeing a meaningful decrease in the incidence of tuberculosis, authorities might want to investigate to find out the cause of the decrease (e.g., was it due to improved prevention efforts? Or better treatment protocols being administered? etc.). 